# 계엄령과 강화학습

## 프로젝트 개요

이 프로젝트는 외국인과 연기금이라는 두 시장 참여자들 행동이 시장 변수(주가, 환율, 금리)에 미치는 영향을 학습하고, 이를 기반으로 시장 동향을 시뮬레이션하는 시스템이다.

두 시장 참여자들의 보상 함수를 최근 뉴스에 근거해 결정하고, 이를 바탕으로 시장 참여자들의 정책을 학습한다.

시장 환경은 지표간 linear model을 가정한다. 예를 들어서, 금리가 오르면 환율이 떨어진다. 떨어지는 비율은 parameterize를 하고 oputa를 이용해 실제 데이터에 model fitting을 한다.

---

## 프로젝트 목표

1. 외국인과 연기금의 행동이 시장 변수에 미치는 영향을 시뮬레이션한다.
2. 실제 데이터와 시뮬레이션 데이터 간의 차이를 최소화하는 최적 파라미터를 탐색한다.
3. 학습된 모델을 활용해 미래 시장 동향을 예측한다.

---

## 디렉토리 구조

```
├── economy-prediction
    ├── .venv
    ├── data
    │   ├── row_data
    │   │   ├── 국채_수익률.xlsx
    │   │   ├── 코스피_순매수_순매도.xlsx
    │   │   └── 환율.xlsx
    │   ├── bond.csv
    │   ├── exchange.csv
    │   ├── processed_data.csv
    │   ├── stock.csv
    │   ├── __init__.py
    │   └── preprocess.py
    ├── models
    │   ├── __init__.py
    │   ├── dqn_agent.py
    │   └── market_env.py
    ├── result
    │   ├── run1.png
    │   ├── run2.png
    │   ├── run3.png
    │   ├── run4.png
    │   └── simulation.png
    ├── test_models
    │   ├── agent_layer.py
    │   ├── heuristic.py
    │   └── lstm_model.py
    ├── utils
    │   ├── __init__.py
    │   └── data_visualizer.py
    ├── best_params.json
    ├── README.md
    ├── best_foreigner_model.pth
    ├── best_fund_model.pth
    ├── main.py
    ├── main2.py
    └── requirements.txt
```

---

## 프로젝트 구성

### 1. 주요 구성 요소

- **`main.py`**:

  - Optuna를 활용해 시장 환경의 파라미터를 최적화.
  - 외국인과 연기금 에이전트의 행동을 학습.
  - 최적의 파라미터와 모델 저장.
  - 실제 데이터와 시뮬레이션 데이터를 비교하여 시각화.

- **`main2.py`**:

  - 최적화된 파라미터를 기반으로 새로운 환경에서 30일간 시장 시뮬레이션 수행.
  - 연기금의 거래 임계값(`k5`) 효과를 분석.

- **`dqn_agent.py`**:

  - 외국인과 연기금의 정책 학습 및 행동을 결정하는 DQN 기반 에이전트 정의.

- **`market_env.py`**:

  - 시장 변수 간 상호작용과 외국인 및 연기금의 행동 보상을 정의하는 시장 환경 모델.

- **`data_visualizer.py`**:

  - 시뮬레이션 결과 및 실제 데이터를 시각화하는 도구.

- **`preprocess.py`**:

  - 주식, 환율, 금리 데이터를 처리하고 공통 날짜로 병합하여 `processed_data.csv`로 저장.

### 2. 데이터 전처리

- **데이터 설명**:

  - `bond.csv`: 국채 수익률 데이터를 포함하며, 날짜와 수익률 컬럼으로 구성된다.
  - `exchange.csv`: 환율 데이터를 포함하며, 날짜와 환율 컬럼으로 구성된다.
  - `stock.csv`: 주식 데이터를 포함하며, 날짜, 외국인 순매수, 연기금 순매수, 체결가 등의 컬럼으로 구성된다.
  - 이 데이터들은 각각 주가, 환율, 금리와 관련된 시장 지표를 나타내며, 시뮬레이션 환경에서 초기 상태와 시장 변화의 기준으로 사용된다.

- **처리 데이터 범위**:

  - 계엄령 공포일인 12월 3일부터 12월 9일까지의 데이터를 처리하여 분석에 사용한다.

- 공통 날짜 데이터를 필터링하여 학습과 시뮬레이션에 적합한 형태로 저장한다.

### 3. 학습 및 최적화

- **Optuna**를 활용해 최적의 시장 환경 파라미터(`k1`\~`k7`) 탐색.
- 외국인과 연기금 에이전트의 행동을 DQN으로 학습.
- 시뮬레이션 데이터와 실제 데이터 간의 MSE를 최소화.

### 4. 시뮬레이션

- 최적화된 모델과 파라미터를 기반으로 새로운 환경에서 시뮬레이션을 수행한다.
- 연기금의 거래 임계값 효과(`k5`)를 분석한다.

---

## 실행 방법

### 1. VScode로 최상위 폴더를 연다

이 프로젝트는 Python 3.10 이상에서 실행되는 것이 권장된다.

가상환경이 활성화된 상태에서 아래 명령어로 필요한 모듈을 설치한다:

```bash
pip install -r requirements.txt
```

### 2. main.py를 실행한다.

폴더 안에 모델이 저장된다.

### 3. main2.py를 실행한다.

저장된 모델을 불러와 미래를 시뮬레이션한다.

---

## 결과 시각화

- **코드 화면 설명**:
  - `mainpy_example.ㅔㅜㅎ`: `main.py`를 실행하면 Optuna가 시장 환경 파라미터를 최적화하는 과정을 출력한다. 각 trial의 MSE 값과 최적의 파라미터가 표시된다.

- **그래프 설명**:

  - `run1.png, run2.png, run3.png, run4.png`: 학습 시뮬레이션 결과를 보여준다. 시뮬레이션된 주가, 환율, 금리와 실제 데이터 간의 차이를 시각화한다.
  - `simulation.png`: main2.py의 실행 결과이다. k5=0을 가정한 뒤 훈련을 다시 하고 마지막 데이터로부터 미래를 시뮬레이션한다. 기존의 parameter와 모델이 시장을 잘 반영할 것이라는 가정 하에, 재훈련은 새로운 시장을 잘 보여줄 것이다.

---

## 주요 결과

- Optuna로 k1,...,k7을 tuning한다. 실제 데이터와의 MSE를 줄여나간다.
  - 단 모델이 실제와 완전히 일치하지는 않았고, Optuna로 Hyperparameter tuning을 할때마다 모델이 크게 변했다. 즉 학습이 stable하지 않다.
- 미래의 시뮬레이션 결과가 설득력있다. 현재 탄액안 가결로 연기금 장관의 증시 부양 의지가 떨어지면, 즉 k5=0이 되면 주가가 폭락할 것을 보여준다.

---

## 향후 개선 사항

1. 더 많은 시장 변수 추가(예: 원자재 가격, 글로벌 경제 지표).
2. 에이전트의 학습 알고리즘 개선(예: 강화 학습 알고리즘 변경).
3. 거래량 데이터의 세분화 및 추가 분석.

---

## 파일 설명

- **`preprocess.py`**: 데이터 전처리.
- **`main.py`**: Optuna를 활용한 학습 및 최적화.
- **`main2.py`**: 새로운 환경에서의 시뮬레이션.
- **`dqn_agent.py`**: 외국인과 연기금 에이전트 정의.
- **`market_env.py`**: 시장 환경 모델 정의.
- **`data_visualizer.py`**: 시각화 도구.

---
